# ==============================================================================
# PostgreSQL Configuration for n8n on WSL2
# ==============================================================================
# Purpose: Tuned settings for n8n workflow automation
# Environment: WSL2 with 8GB RAM limit, SSD storage
# Session: phase01-session03-postgresql-tuning
# Created: 2025-12-26
#
# This configuration optimizes PostgreSQL for:
# - 5 n8n workers + 1 main instance
# - WSL2 memory constraints
# - SSD storage characteristics
#
# To apply: Restart PostgreSQL container after mounting this file
# To rollback: Remove volume mount and command override from docker-compose.yml
# ==============================================================================

# ------------------------------------------------------------------------------
# Memory Settings
# ------------------------------------------------------------------------------
# Conservative allocation for 8GB WSL2 environment

# Main database cache - ~25% of available memory for PostgreSQL
# Increase from default 128MB to improve cache hit rate
shared_buffers = 512MB

# Query planner hint for OS cache availability
# Not actual allocation, guides query planning decisions
effective_cache_size = 2GB

# Per-operation memory for sorts, hashes, joins
# Increase from default 4MB for complex workflow queries
work_mem = 32MB

# Memory for maintenance operations (VACUUM, CREATE INDEX)
# Higher value speeds up maintenance tasks
maintenance_work_mem = 128MB

# ------------------------------------------------------------------------------
# Connection Settings
# ------------------------------------------------------------------------------
# Sized for: 5 workers + 1 main + administrative overhead

# Listen on all interfaces for container networking
listen_addresses = '*'

# Maximum concurrent connections
# Formula: workers(5) + main(1) + monitoring(2) + admin(2) + buffer(90)
max_connections = 100

# ------------------------------------------------------------------------------
# Write-Ahead Log (WAL) Settings
# ------------------------------------------------------------------------------
# Optimized for balanced durability and performance

# WAL buffer size - adequate for our shared_buffers
wal_buffers = 16MB

# Spread checkpoint I/O over time to reduce spikes
# 0.9 = complete checkpoint over 90% of checkpoint interval
checkpoint_completion_target = 0.9

# ------------------------------------------------------------------------------
# Query Planner (SSD Optimization)
# ------------------------------------------------------------------------------
# WSL2 uses virtual disk on SSD - tune accordingly

# Random I/O cost relative to sequential
# Default 4.0 is for spinning disks; 1.1 for SSD
random_page_cost = 1.1

# Concurrent I/O operations the disk can handle
# SSDs support high parallelism (default is 1)
effective_io_concurrency = 200

# ------------------------------------------------------------------------------
# Logging (minimal for production)
# ------------------------------------------------------------------------------
# Keep logging lightweight

log_destination = 'stderr'
logging_collector = off

# Only log slow queries (>1 second) and errors
log_min_duration_statement = 1000
log_min_messages = error

# ==============================================================================
# End of configuration
# ==============================================================================
