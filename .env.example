# ===========================================
# n8n Docker Stack Environment Configuration
# ===========================================
# Copy this file to .env and fill in your values
# NEVER commit .env to version control
#
# Generated: 2025-12-27
# Documentation: docs/CONFIGURATION.md
# ===========================================

# ===========================================
# N8N IMAGE CONFIGURATION
# ===========================================
# Toggle between official n8n image and custom fork
# Official: n8nio/n8n:<version>
# Custom:   ghcr.io/moshehbenavraham/n8n:<version>
N8N_IMAGE=n8nio/n8n:2.1.4

# Version tracking (update when using custom fork)
# Uncomment N8N_FORK_VERSION when running custom image
# N8N_FORK_VERSION=2.1.4-custom.2
N8N_UPSTREAM_VERSION=2.1.4

# ===========================================
# PostgreSQL Configuration
# ===========================================
# Database credentials for n8n persistence
# Generate password: openssl rand -base64 32
POSTGRES_USER=n8n
POSTGRES_PASSWORD=<generate-secure-password-here>
POSTGRES_DB=n8n
POSTGRES_HOST=postgres
POSTGRES_PORT=5432

# ===========================================
# Redis Configuration
# ===========================================
# Message broker for queue mode
# Using non-standard port to avoid conflicts with other Redis instances
REDIS_HOST=redis
REDIS_PORT=6386

# ===========================================
# n8n Core Configuration
# ===========================================
# Generate key: openssl rand -base64 32
# WARNING: Changing this after setup makes existing credentials unrecoverable
N8N_ENCRYPTION_KEY=<generate-encryption-key-here>

# Host configuration (localhost for development, ngrok domain for external access)
N8N_HOST=localhost
N8N_PORT=5678
N8N_PROTOCOL=http
WEBHOOK_URL=http://localhost:5678/

# Timezone for scheduled workflows
GENERIC_TIMEZONE=America/New_York
N8N_USER_FOLDER=/home/node/.n8n

# ===========================================
# n8n Queue Mode (Required for Workers)
# ===========================================
# Enable distributed execution across workers
EXECUTIONS_MODE=queue
QUEUE_BULL_REDIS_HOST=redis
QUEUE_BULL_REDIS_PORT=6386
QUEUE_HEALTH_CHECK_ACTIVE=true
QUEUE_BULL_REDIS_TIMEOUT_THRESHOLD=60000

# ===========================================
# n8n Worker Scaling Configuration
# ===========================================
# Concurrent executions per worker (5 workers x 10 = 50 total capacity)
EXECUTIONS_CONCURRENCY=10
# Route manual executions to workers (keeps UI responsive)
OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true

# ===========================================
# n8n Logging Configuration
# ===========================================
# Log level: error, warn, info, debug (default: info)
N8N_LOG_LEVEL=info
# Execution process log output: console, file (default: console)
N8N_LOG_OUTPUT=console

# ===========================================
# n8n Data Management
# ===========================================
# Auto-prune old execution data to prevent database bloat
EXECUTIONS_DATA_PRUNE=true
EXECUTIONS_DATA_MAX_AGE=168
EXECUTIONS_DATA_PRUNE_MAX_COUNT=50000
# Enable Prometheus-compatible metrics at /metrics
N8N_METRICS=true

# ===========================================
# n8n Security
# ===========================================
# Set to 'false' for localhost HTTP development
# Set to 'true' when using HTTPS (ngrok, reverse proxy)
N8N_SECURE_COOKIE=false
# Required when running behind a reverse proxy (ngrok, nginx, etc.)
# Enables Express to trust X-Forwarded-* headers for rate limiting
N8N_TRUST_PROXY=true

# ===========================================
# Database Connection
# ===========================================
# PostgreSQL connection for n8n (references variables above)
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=postgres
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n
DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}

# ===========================================
# ngrok Tunnel Configuration (Phase 02)
# ===========================================
# Get authtoken from: https://dashboard.ngrok.com/get-started/your-authtoken
# Custom domain configured in ngrok dashboard
NGROK_AUTHTOKEN=<your-ngrok-authtoken-here>
NGROK_DOMAIN=<your-custom-domain>.ngrok.dev
NGROK_INSPECTOR_PORT=4040

# ===========================================
# External Access Configuration (Phase 02)
# ===========================================
# Uncomment and update these when enabling ngrok tunnel:
#
# N8N_HOST=your-custom-domain.ngrok.dev
# N8N_PROTOCOL=https
# WEBHOOK_URL=https://your-custom-domain.ngrok.dev/
# N8N_SECURE_COOKIE=true

# ===========================================
# Backup Encryption Configuration (Phase 03)
# ===========================================
# GPG passphrase for symmetric backup encryption
# Generate: openssl rand -base64 32
# WARNING: Store securely - losing this makes encrypted backups unrecoverable
BACKUP_GPG_PASSPHRASE=<generate-secure-passphrase-here>

# ===========================================
# Off-site Backup Configuration (Phase 03)
# ===========================================
# rclone remote name (configured via 'rclone config')
# Install rclone: curl https://rclone.org/install.sh | sudo bash
RCLONE_REMOTE=n8n-backup
# Remote bucket/container name
RCLONE_BUCKET=n8n-backups
# Sync encrypted files only (recommended: true)
RCLONE_SYNC_ENCRYPTED_ONLY=true

# ===========================================
# Auto-Scaling Configuration (Phase 03)
# ===========================================
# Enable/disable queue-based worker auto-scaling
AUTOSCALE_ENABLED=true
# Minimum number of workers (never scale below this)
AUTOSCALE_MIN_WORKERS=1
# Maximum number of workers (never scale above this)
AUTOSCALE_MAX_WORKERS=10
# Queue depth threshold to trigger scale-up
AUTOSCALE_HIGH_THRESHOLD=20
# Queue depth threshold to trigger scale-down
AUTOSCALE_LOW_THRESHOLD=5
# Cooldown period between scaling actions (seconds)
AUTOSCALE_COOLDOWN_SECONDS=120
# Log file for auto-scaling events
AUTOSCALE_LOG_FILE=logs/autoscale.log

# ===========================================
# Coolify Deployment Configuration
# ===========================================
# API token with write/deploy/read permissions
# Get from: Coolify Dashboard > Security > API Tokens
COOLIFY_API_TOKEN=<your-coolify-api-token-here>
# Base URL for Coolify API (e.g., https://coolify.domain.com/api/v1)
COOLIFY_API_URL=https://coolify.yourdomain.com/api/v1
# GitHub repository (format: owner/repo.git)
GITHUB_REPO=your-org/your-repo.git
# Branch to deploy
GITHUB_BRANCH=main
# Application name in Coolify
APP_NAME=n8n
# Domain for the deployed application
APP_DOMAIN=n8n.yourdomain.com
